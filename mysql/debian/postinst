#!/bin/sh

set -e

#
# Skip, if we are not in "configure" state
#
if [ "$1" != "configure" ]; then
        echo "I: Skipping configuration"
        exit 0
fi

#DEBHELPER#

#
# Add symlinks for the monit script
#Â 
monit_dir="/etc/symbiosis/monit.d"
mkdir -p "$monit_dir"

for i in mysqld; do
  monit_script="/usr/share/symbiosis/monit/checks/$i"
  link_target="$monit_dir/$i"

  if [ -x "$monit_script" ] && [ ! -e "$link_target" ]; then
    echo "I: Adding symlink for Symbiosis Monit script for $i"
    ln -s "$monit_script" "$link_target" || true
  fi
done

#
# Restart mysql just in case the config has been modified.
#
invoke-rc.d mysql restart

#
# And upgrade mysql, if we can.
#
if [ -x /usr/bin/mysql_upgrade ] ; then
  echo "I: Upgrading MySQL"
  /usr/bin/mysql_upgrade --defaults-file=/etc/mysql/debian.cnf || true
fi

#
# Recreate debian-sys-maint user and disable unix_socket auth 
#
if ( grep -qx 'password = ' /etc/mysql/debian.cnf ) ; then
  password=$(tr -dc '[:alnum:]' < /dev/urandom  | dd bs=4 count=4 2> /dev/null)
  mysql -u root -e "grant all privileges on *.* TO 'debian-sys-maint'@'localhost' identified by '$password' with grant option;"
  mysql -u root -e "update mysql.user set plugin= '' where user= 'root'; flush privileges;"
  sed -i "s|user     = root|user     = debian-sys-maint|" /etc/mysql/debian.cnf
  sed -i "s|password =|password = $password|" /etc/mysql/debian.cnf
fi

exit 0
